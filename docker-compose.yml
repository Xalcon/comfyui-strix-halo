version: "3.9"

services:
  comfyui:
    build: .
    container_name: comfortable-strix-halo
    user: "1000:1000"

    command: ["comfy", "launch", "--listen", "127.0.0.1"]
    ipc: host
    shm_size: 8g

    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined

    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

    group_add:
      - video

    environment:
      HSA_OVERRIDE_GFX_VERSION: "11.0.0"

    volumes:
      - ./models:/app/comfyui/models

    tty: true

  nginx:
    image: nginx:alpine
    container_name: comfyui-proxy

    # ðŸ”‘ Share network namespace with ComfyUI
    network_mode: "service:comfyui"

    depends_on:
      - comfyui

    ports:
      - "8080:80"   # ONLY externally exposed port

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
